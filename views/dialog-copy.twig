{% set pathbrowse = isValidPath(currentPath)? currentPath : '/' %}
{% set multiselect = 1 %}
{% set multiselectFilesOnly = false %}
{% set startButtonValue = theUILang.fDiagCopyBut %}

{% extends "flm::dialog-window.twig" %}
{% block heading %}
    <legend>{{ theUILang.fDiagCopySel }} </legend>
{% endblock %}

{% block scripts %}
    <script>
        (function () {
            const dialogs = flm.ui.getDialogs();
            const diagId = dialogs.getDialogId();
            const pathBrowser = dialogs.pathBrowserInput(diagId);

            let self = this;

            self.doCopy = function (destination, filePaths) {

                destination = $.trim(destination);

                var deferred = $.Deferred();
                flm.manager.logConsole(theUILang.fStarts.copy, filePaths.length + " files");

                if (!destination.length) {
                    // flm.manager.logAction('copy', theUILang.fDiagInvalidname);
                    deferred.reject(theUILang.fDiagInvalidname);
                    return deferred.promise();
                }

                if (!$type(filePaths) || filePaths.length === 0) {
                    deferred.reject('Empty paths');
                    return deferred.promise();
                }

                if (!flm.utils.isValidPath(destination)) {
                    // flm.manager.logAction('copy', theUILang.fDiagInvalidname);
                    deferred.reject(theUILang.fDiagInvalidname);
                    return deferred.promise();
                }

                var cPath = flm.getCurrentPath();

                return flm.api.copy(filePaths, flm.manager.stripJailPath(destination))
                    .then(function (result) {
                            // in case we are in destination
                            flm.Refresh(filePaths.length > 1 ? destination : cPath);
                            return result;
                        },
                        function (response) {
                            return response;
                        });
            }

            self.onStart = function () {
                dialogs.disableStartButton();
                return self.doCopy(dialogs.getTargetPath(diagId), dialogs.getCheckedList(diagId)).then(

                );
            };

            self.updateFilePath = function () {
                let filePath = flm.utils.replaceFilePath(pathBrowser.val(), pathBrowser.data('previousValue'));
                dialogs.updateTargetPath(diagId, filePath);
            };

            dialogs.onStart(self.onStart);
            pathBrowser.change(self.updateFilePath);

            const entries = dialogs.getCheckedList(diagId);
            if (entries.length === 1) {
                pathBrowser.data('previousValue', 'Copy of ' + flm.utils.basename(entries[0]))
                    .change();
            }

        })
        (window);
    </script>
{% endblock %}
